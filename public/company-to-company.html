<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Comparison</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .metric-row:nth-child(even) {
            background-color: #f9fafb;
        }
        .metric-row:hover {
            background-color: #f3f4f6;
        }
        .section-header {
            background-color: #e5e7eb;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-4">
        <div class="max-w-4xl mx-auto space-y-4">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow p-4">
                <h1 class="text-xl font-bold text-gray-900 mb-4">Financial Comparison</h1>

                <!-- Selectors Row -->
                <div class="grid grid-cols-2 gap-6">
                    <!-- Company 1 Selector -->
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-blue-600">Company 1</label>
                        <div class="flex gap-2">
                            <select id="company1-select" class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Loading...</option>
                            </select>
                            <select id="year1-select" class="w-24 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="2018">2018</option>
                                <option value="2019">2019</option>
                                <option value="2020">2020</option>
                                <option value="2021">2021</option>
                                <option value="2022">2022</option>
                                <option value="2023" selected>2023</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                    </div>

                    <!-- Company 2 Selector -->
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-green-600">Company 2</label>
                        <div class="flex gap-2">
                            <select id="company2-select" class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Loading...</option>
                            </select>
                            <select id="year2-select" class="w-24 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="2018">2018</option>
                                <option value="2019">2019</option>
                                <option value="2020">2020</option>
                                <option value="2021">2021</option>
                                <option value="2022">2022</option>
                                <option value="2023" selected>2023</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden bg-white rounded-lg shadow p-4 text-center text-gray-500">
                <span class="loading-spinner mr-2"></span>
                Loading financial data...
            </div>

            <!-- Error Display -->
            <div id="error-display" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 text-red-700"></div>

            <!-- Comparison Table -->
            <div id="table-container" class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700 w-2/5">Metric</th>
                            <th id="header1" class="px-4 py-3 text-right font-semibold text-blue-600 w-[30%]">Company 1</th>
                            <th id="header2" class="px-4 py-3 text-right font-semibold text-green-600 w-[30%]">Company 2</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr><td colspan="3" class="px-4 py-8 text-center text-gray-400">Select companies to compare</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // DoltHub API Configuration
        const DB_URL = 'https://www.dolthub.com/api/v1alpha1/calvinw/BusMgmtBenchmarks/main';

        // Currency mapping by company
        const currencyMap = {
            'Amazon': '$',
            'Walmart': '$',
            'Costco': '$',
            "Macy's": '$',
            'Target': '$',
            'Best Buy': '$',
            'Home Depot': '$',
            'Lowe\'s': '$',
            'CVS': '$',
            'Walgreens': '$',
        };

        // Financial metrics to display (in order) - matching reference layout
        // Section 1: Financial Numbers (raw data in thousands)
        const FINANCIAL_NUMBERS = [
            'Net Revenue',
            'Cost of Goods',
            'Gross Margin',
            'SGA',
            'Operating Profit',
            'Net Profit',
            'Inventory',
            'Total Assets',
        ];

        // Section 2: Financial Indicators (calculated percentages and ratios)
        const FINANCIAL_INDICATORS = [
            'Cost of Goods %',
            'Gross Margin %',
            'SGA %',
            'Operating Profit Margin %',
            'Net Profit Margin %',
            'Inventory Turnover',
            'Current Ratio',
            'Quick Ratio',
            'Debt to Equity',
            'Asset Turnover',
            'Return on Assets',
            'Three Year Revenue CAGR',
        ];

        // DOM Elements
        const company1Select = document.getElementById('company1-select');
        const year1Select = document.getElementById('year1-select');
        const company2Select = document.getElementById('company2-select');
        const year2Select = document.getElementById('year2-select');
        const header1 = document.getElementById('header1');
        const header2 = document.getElementById('header2');
        const tableBody = document.getElementById('table-body');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorDisplay = document.getElementById('error-display');

        // State
        let state = {
            company1: 'Walmart',
            year1: '2023',
            company2: 'Amazon',
            year2: '2023'
        };

        let companyData1 = null;
        let companyData2 = null;

        // Utility function to round to one decimal place
        function roundToTenth(num) {
            return Math.round(num * 10) / 10;
        }

        // Fetch company list from database
        async function fetchCompanyList() {
            try {
                const query = encodeURIComponent('SELECT DISTINCT company_name FROM financials ORDER BY company_name');
                const response = await fetch(`${DB_URL}?q=${query}`);
                const data = await response.json();

                if (data.query_execution_status === 'Success') {
                    return data.rows.map(row => row.company_name);
                }
                return [];
            } catch (error) {
                console.error('Error fetching company list:', error);
                return [];
            }
        }

        // Fetch CAGR separately
        async function fetchCAGR(company, year) {
            try {
                const escapedCompany = company.replace(/'/g, "''");
                const query = encodeURIComponent(`SELECT Three_Year_Revenue_CAGR FROM financial_metrics WHERE company_name='${escapedCompany}' AND year=${year}`);
                const response = await fetch(`${DB_URL}?q=${query}`);
                const data = await response.json();

                if (data.query_execution_status === 'Success' && data.rows.length > 0) {
                    return data.rows[0].Three_Year_Revenue_CAGR;
                }
                return null;
            } catch (error) {
                console.error('Error fetching CAGR:', error);
                return null;
            }
        }

        // Calculate financial indicators from raw data
        function calculateFinancialIndicators(row) {
            if (!row) return {};

            const indicators = {};
            const nums = {
                netRevenue: Number(row['Net Revenue']) || 0,
                costOfGoods: Number(row['Cost of Goods']) || 0,
                grossMargin: Number(row['Gross Margin']) || 0,
                sga: Number(row['SGA']) || 0,
                operatingProfit: Number(row['Operating Profit']) || 0,
                netProfit: Number(row['Net Profit']) || 0,
                inventory: Number(row['Inventory']) || 0,
                currentAssets: Number(row['Current Assets']) || 0,
                totalAssets: Number(row['Total Assets']) || 0,
                currentLiabilities: Number(row['Current Liabilities']) || 0,
                totalShareholderEquity: Number(row['Total Shareholder Equity']) || 0,
                totalLiabilitiesAndEquity: Number(row['Total Liabilities and Shareholder Equity']) || 0
            };

            // Percentage calculations
            if (nums.netRevenue > 0) {
                indicators['Cost of Goods %'] = roundToTenth((nums.costOfGoods / nums.netRevenue) * 100);
                indicators['Gross Margin %'] = roundToTenth((nums.grossMargin / nums.netRevenue) * 100);
                indicators['SGA %'] = roundToTenth((nums.sga / nums.netRevenue) * 100);
                indicators['Operating Profit Margin %'] = roundToTenth((nums.operatingProfit / nums.netRevenue) * 100);
                indicators['Net Profit Margin %'] = roundToTenth((nums.netProfit / nums.netRevenue) * 100);
            }

            // Ratio calculations
            if (nums.inventory > 0) {
                indicators['Inventory Turnover'] = roundToTenth(nums.costOfGoods / nums.inventory);
            }
            if (nums.currentLiabilities > 0) {
                indicators['Current Ratio'] = roundToTenth(nums.currentAssets / nums.currentLiabilities);
                indicators['Quick Ratio'] = roundToTenth((nums.currentAssets - nums.inventory) / nums.currentLiabilities);
            }
            if (nums.totalShareholderEquity > 0) {
                const totalDebt = nums.totalLiabilitiesAndEquity - nums.totalShareholderEquity;
                indicators['Debt to Equity'] = roundToTenth(totalDebt / nums.totalShareholderEquity);
            }
            if (nums.totalAssets > 0) {
                indicators['Asset Turnover'] = roundToTenth(nums.netRevenue / nums.totalAssets);
                // ROA = Net Profit Margin % Ã— Asset Turnover (using rounded displayed values)
                const netProfitMargin = indicators['Net Profit Margin %'] || 0;
                const assetTurnover = indicators['Asset Turnover'] || 0;
                indicators['Return on Assets'] = roundToTenth(netProfitMargin * assetTurnover);
            }

            return indicators;
        }

        // Fetch company financial data
        async function fetchCompanyData(company, year) {
            if (!company || !year) return null;

            try {
                const escapedCompany = company.replace(/'/g, "''");
                const query = encodeURIComponent(`SELECT * FROM financials WHERE company_name='${escapedCompany}' AND year=${year}`);
                const response = await fetch(`${DB_URL}?q=${query}`);
                const data = await response.json();

                if (data.query_execution_status === 'Success' && data.rows.length > 0) {
                    const row = data.rows[0];
                    row.company = company;
                    row.year = year;

                    // Calculate derived indicators
                    const indicators = calculateFinancialIndicators(row);
                    Object.assign(row, indicators);

                    // Fetch CAGR separately
                    const cagr = await fetchCAGR(company, year);
                    if (cagr !== null) {
                        row['Three Year Revenue CAGR'] = cagr;
                    }

                    return row;
                }
                return null;
            } catch (error) {
                console.error('Error fetching company data:', error);
                return null;
            }
        }

        // Format value for display
        function formatValue(value, fieldName, company) {
            if (value === null || value === undefined) return 'N/A';

            const num = Number(value);
            if (isNaN(num)) return 'N/A';

            // Percentage fields
            if (fieldName.includes('%') || fieldName === 'Three Year Revenue CAGR' || fieldName === 'Return on Assets') {
                return num.toLocaleString(undefined, {
                    minimumFractionDigits: 1,
                    maximumFractionDigits: 1
                }) + '%';
            }

            // Currency fields
            const currencyFields = ['Net Revenue', 'Cost of Goods', 'Gross Margin', 'SGA', 'Operating Profit',
                                     'Net Profit', 'Inventory', 'Current Assets', 'Total Assets',
                                     'Current Liabilities', 'Total Shareholder Equity'];
            if (currencyFields.includes(fieldName)) {
                const symbol = currencyMap[company] || '$';
                return symbol + num.toLocaleString(undefined, {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            }

            // Ratio fields
            return num.toLocaleString(undefined, {
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            });
        }

        // Render a section of the table
        function renderSection(title, metrics, data1, data2, company1, company2) {
            let html = `<tr class="section-header"><td colspan="3" class="px-4 py-2 text-gray-700">${title}</td></tr>`;

            for (const metric of metrics) {
                const val1 = data1 ? formatValue(data1[metric], metric, company1) : 'N/A';
                const val2 = data2 ? formatValue(data2[metric], metric, company2) : 'N/A';

                html += `
                    <tr class="metric-row border-b border-gray-100">
                        <td class="px-4 py-2 text-gray-600">${metric}</td>
                        <td class="px-4 py-2 text-right font-mono text-gray-900">${val1}</td>
                        <td class="px-4 py-2 text-right font-mono text-gray-900">${val2}</td>
                    </tr>
                `;
            }

            return html;
        }

        // Update the comparison table
        function renderTable() {
            const company1 = state.company1;
            const company2 = state.company2;

            // Update headers
            header1.textContent = companyData1 ? `${company1} (${state.year1})` : 'Company 1';
            header2.textContent = companyData2 ? `${company2} (${state.year2})` : 'Company 2';

            if (!companyData1 && !companyData2) {
                tableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-8 text-center text-gray-400">Select companies to compare</td></tr>';
                return;
            }

            let html = '';
            html += renderSection('Financial Numbers (in thousands)', FINANCIAL_NUMBERS, companyData1, companyData2, company1, company2);
            html += renderSection('Financial Indicators', FINANCIAL_INDICATORS, companyData1, companyData2, company1, company2);

            tableBody.innerHTML = html;
        }

        // Show/hide loading state
        function setLoading(isLoading) {
            loadingIndicator.classList.toggle('hidden', !isLoading);
        }

        // Show error message
        function showError(message) {
            errorDisplay.textContent = message;
            errorDisplay.classList.remove('hidden');
            setTimeout(() => errorDisplay.classList.add('hidden'), 5000);
        }

        // Fetch data and update table
        async function updateData() {
            setLoading(true);
            errorDisplay.classList.add('hidden');

            try {
                // Fetch both companies in parallel
                const [data1, data2] = await Promise.all([
                    fetchCompanyData(state.company1, state.year1),
                    fetchCompanyData(state.company2, state.year2)
                ]);

                companyData1 = data1;
                companyData2 = data2;

                if (!data1 && state.company1) {
                    showError(`No data found for ${state.company1} (${state.year1})`);
                }
                if (!data2 && state.company2) {
                    showError(`No data found for ${state.company2} (${state.year2})`);
                }

                renderTable();
            } catch (error) {
                console.error('Error updating data:', error);
                showError('Error fetching data. Please try again.');
            } finally {
                setLoading(false);
            }
        }

        // Update state from dropdowns
        function updateState() {
            state.company1 = company1Select.value;
            state.year1 = year1Select.value;
            state.company2 = company2Select.value;
            state.year2 = year2Select.value;
        }

        // Handle dropdown changes
        function handleSelectionChange() {
            updateState();
            updateData();
        }

        // Populate company dropdowns
        async function populateCompanyDropdowns(companies) {
            const createOptions = (selectEl, defaultValue) => {
                selectEl.innerHTML = '<option value="">Select company</option>';
                for (const company of companies) {
                    const option = document.createElement('option');
                    option.value = company;
                    option.textContent = company;
                    if (company === defaultValue) {
                        option.selected = true;
                    }
                    selectEl.appendChild(option);
                }
            };

            createOptions(company1Select, state.company1);
            createOptions(company2Select, state.company2);
        }

        // Initialize the application
        async function init() {
            setLoading(true);

            // Fetch company list
            const companies = await fetchCompanyList();

            if (companies.length === 0) {
                showError('Could not load company list from database');
                setLoading(false);
                return;
            }

            // Populate dropdowns
            await populateCompanyDropdowns(companies);

            // Set initial values
            company1Select.value = state.company1;
            year1Select.value = state.year1;
            company2Select.value = state.company2;
            year2Select.value = state.year2;

            // Add event listeners
            company1Select.addEventListener('change', handleSelectionChange);
            year1Select.addEventListener('change', handleSelectionChange);
            company2Select.addEventListener('change', handleSelectionChange);
            year2Select.addEventListener('change', handleSelectionChange);

            // Fetch initial data
            await updateData();
        }

        // PostMessage API for parent window communication
        window.addEventListener('message', (event) => {
            const { type, data } = event.data;

            switch (type) {
                case 'GET_STATE':
                    // Return current state to parent
                    event.source.postMessage({
                        type: 'STATE_RESPONSE',
                        state: state
                    }, '*');
                    break;

                case 'SET_STATE':
                    // Update state from parent
                    let changed = false;
                    if (data.company1 !== undefined && data.company1 !== state.company1) {
                        company1Select.value = data.company1;
                        state.company1 = data.company1;
                        changed = true;
                    }
                    if (data.year1 !== undefined && data.year1 !== state.year1) {
                        year1Select.value = data.year1;
                        state.year1 = data.year1;
                        changed = true;
                    }
                    if (data.company2 !== undefined && data.company2 !== state.company2) {
                        company2Select.value = data.company2;
                        state.company2 = data.company2;
                        changed = true;
                    }
                    if (data.year2 !== undefined && data.year2 !== state.year2) {
                        year2Select.value = data.year2;
                        state.year2 = data.year2;
                        changed = true;
                    }

                    // Fetch new data if state changed
                    if (changed) {
                        updateData();
                    }
                    break;
            }
        });

        // Notify parent when ready
        function notifyReady() {
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'IFRAME_READY',
                    state: state
                }, '*');
            }
        }

        // Start the app
        init().then(() => {
            notifyReady();
        });
    </script>
</body>
</html>
